<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* กำหนดฟอนต์ Inter สำหรับ Tailwind (แนะนำสำหรับ UI) */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Style for alert status badges */
        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
        }
        
        /* *** CSS เพื่อให้พอดีหน้าจอ 100% (Full Screen) และไม่ให้เกิด Scrollbar หลัก *** */
        html, body {
            height: 100%; /* ใช้ความสูงเต็ม viewport */
            margin: 0;
            padding: 0;
        }
        .full-screen-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1.5rem; /* ลด p-8 เป็น p-6 (1.5rem) เพื่อให้มีพื้นที่เหลือมากขึ้น */
            overflow: hidden; /* ป้องกัน scrollbar หลัก */
        }
        
        /* ให้ Main Content ใช้พื้นที่ที่เหลือทั้งหมด */
        .main-content-area {
            flex-grow: 1;
        }
        
    </style>
</head>
<body class="bg-gray-50 full-screen-container">
    
    <script>
        // =================================================================================================================================================
        // ส่วนที่ 1: การกำหนดค่าและ URL ของแหล่งข้อมูล
        // =================================================================================================================================================
        
        // *************************************************************************************************************************************************
        // ** สำคัญ: กรุณาแทนที่ URL ตัวอย่างเหล่านี้ด้วย URL จริงของ Google Sheets ที่คุณเผยแพร่เป็น CSV และ Dustboy API URL **
        // *************************************************************************************************************************************************
        const GOOGLE_SHEET_URL_1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT452CdpcF_hoA-_x3a6Ji0YKeWTuSr_9CM0We83aAAPiBWMRoHrKEujaYtEzHMZYMLEL8wKa10NPYF/pub?gid=675852265&single=true&output=csv"; // ตรวจวัดระดับ
        const GOOGLE_SHEET_URL_2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5OYSm3Hn1V4kegJf9x3iK2OGvUIL7vbnWryNUsx15VCm4NdxoVoWZMx1vWTlKcZskeD-YYjhbKn2V/pub?gid=202563025&single=true&output=csv"; // ข้อมูลระดับน้ำเจ้าพระยา
        const GOOGLE_SHEET_URL_3 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyPcfGQReUPOHckF-6bA4UOucC8cbqRvHj-aTP7uWRkBjvQ4HrieGIhcet4OH9O0DjT_M2FM3QaaV9/pub?gid=273571070&single=true&output=csv"; // ข้อมูลการตรวจสอบการทำงานของเครื่องสูบน้ำ
        const DUSTBOY_API_URL = "https://api.example.com/dustboy/latest_data"; // URL สำหรับ Dustboy API (โปรดแทนที่ด้วย URL จริง)

        // ระยะเวลาการอัปเดต: 1 ชั่วโมง = 3600000 มิลลิวินาที
        const UPDATE_INTERVAL_MS = 3600000;
        //const UPDATE_INTERVAL_MS = 10000; // สำหรับการทดสอบ: 10 วินาที

        // =================================================================================================================================================
        // ส่วนที่ 2: ฟังก์ชันช่วยเหลือและการกำหนดคีย์มาตรฐาน
        // =================================================================================================================================================
        
        /**
         * ทำความสะอาดข้อความ โดยการลบช่องว่างทั้งหมด (รวมถึงช่องว่างที่ซ่อนอยู่)
         * เพื่อให้มั่นใจว่าการเปรียบเทียบคำภาษาไทยถูกต้อง
         * @param {string} text - ข้อความที่ต้องการทำความสะอาด
         * @returns {string} ข้อความที่ถูกทำความสะอาดแล้ว
         */
        function sanitizeText(text) {
            if (!text) return '';
            // ลบช่องว่าง (Space), Newline/Tab, และอักขระ BOM ออกทั้งหมด
            return text.trim().replace(/\s+/g, '').replace(/\uFEFF/g, '');
        }

        /**
         * แผนที่คีย์มาตรฐานที่ใช้ในการดึงข้อมูลจาก Array Object 
         * ทุกคีย์ต้องถูก sanitize เพื่อให้ทนทานต่อช่องว่างแฝง
         */
        const KEY_MAP = {
            // Keys for Water Level (Sheet 1 & 2)
            WATER_POINT: sanitizeText('จุดวัดระดับน้ำ'),
            CURRENT_LEVEL: sanitizeText('ระดับน้ำปัจจุบัน'),
            DIFF_LEVEL: sanitizeText('ส่วนต่างระดับน้ำ'),
            ALERT_LEVEL: sanitizeText('ระดับการแจ้งเตือน'),

            // Keys for Pump Status (Sheet 3)
            PUMP_STATION: sanitizeText('สถานีสูบน้ำ'),
            PUMP_STATUS: sanitizeText('สถานะปั๊ม'),
            LAST_UPDATE: sanitizeText('เวลาล่าสุด'),
            INSPECTIONS: sanitizeText('จำนวนครั้งที่เข้าตรวจ'),
        };

        /**
         * ฟังก์ชันแปลง CSV string เป็น Array of Objects
         * **ปรับปรุง:** ใช้ sanitizeText กับ Header เพื่อให้ Key ของ Object สะอาดและแม่นยำ
         * @param {string} csvText - ข้อความ CSV ที่ดึงมาจาก Google Sheet
         * @returns {Array<Object>} ข้อมูลที่แปลงแล้ว
         */
        function csvToArray(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            // 1. ประมวลผล Header: ทำความสะอาดอย่างเข้มข้นเพื่อใช้เป็น Key
            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const cleanHeaders = rawHeaders.map(h => sanitizeText(h)); // ใช้ sanitizeText กับ Header
            
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentLine = lines[i];
                
                // 2. ประมวลผล Value
                const values = currentLine.split(',').map(v => v.trim().replace(/"/g, ''));
                
                if (values.length === cleanHeaders.length) {
                    for (let j = 0; j < cleanHeaders.length; j++) {
                        // ใช้ Header ที่ถูกทำความสะอาดแล้วเป็น Key
                        obj[cleanHeaders[j]] = values[j]; 
                    }
                    result.push(obj);
                } else {
                    console.warn(`[Parsing Error] Skipping data line ${i+1}: Column count mismatch. Expected ${cleanHeaders.length}, Got ${values.length}. Line: "${currentLine}"`);
                }
            }
            console.log("Parsed Clean Headers (Key Names):", cleanHeaders);
            console.log(`Successfully parsed ${result.length} data rows.`);
            return result;
        }

        /**
         * ฟังก์ชันหลักในการดึงข้อมูลจาก Google Sheet (CSV)
         * @param {string} url - URL ของ Google Sheet ที่เผยแพร่เป็น CSV
         * @returns {Promise<Array<Object>>} ข้อมูลในรูปแบบ Array of Objects
         */
        async function fetchDataFromSheet(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${url}`);
                }
                const csvText = await response.text();
                return csvToArray(csvText);
            } catch (error) {
                console.error("Error fetching or parsing sheet data:", error);
                // ข้อมูลจำลองเมื่อดึงข้อมูลไม่ได้ - ใช้คีย์ที่ถูก sanitize แล้ว
                return [
                    { [KEY_MAP.WATER_POINT]: 'N/A (Error)', [KEY_MAP.ALERT_LEVEL]: 'ไม่ได้เชื่อมต่อ' },
                ];
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 3: ฟังก์ชันดึงข้อมูลเฉพาะสำหรับแต่ละแหล่ง (ไม่เปลี่ยนแปลง)
        // =================================================================================================================================================

        async function fetchWaterLevelData() {
            console.log("Fetching data from Sheet 1 (Water Level Monitoring)...");
            return fetchDataFromSheet(GOOGLE_SHEET_URL_1);
        }

        async function fetchChaoPhrayaData() {
            console.log("Fetching data from Sheet 2 (Chao Phraya Level)...");
            return fetchDataFromSheet(GOOGLE_SHEET_URL_2);
        }

        async function fetchPumpStatusData() {
            console.log("Fetching data from Sheet 3 (Pump Status)...");
            return fetchDataFromSheet(GOOGLE_SHEET_URL_3);
        }

        async function fetchDustboyData() {
            try {
                console.log("Fetching data from Dustboy API...");
                const response = await fetch(DUSTBOY_API_URL); // สมมติว่า Dustboy API เป็น JSON
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                const latestData = Array.isArray(data) ? data[0] : data; 

                return {
                    location: latestData.location || "ไม่ระบุตำแหน่ง",
                    pm25: latestData.pm25 || "N/A",
                    status: latestData.status || "ปกติ", 
                    timestamp: latestData.timestamp ? new Date(latestData.timestamp).toLocaleTimeString('th-TH') : new Date().toLocaleTimeString('th-TH')
                };

            } catch (error) {
                console.error("Error fetching Dustboy data:", error);
                // ข้อมูลจำลองในกรณีที่ผิดพลาด
                return {
                    location: "จำลอง: กรุงเทพมหานคร",
                    pm25: 35,
                    status: "ดีมาก (จำลอง)",
                    timestamp: new Date().toLocaleTimeString('th-TH')
                };
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 4: ฟังก์ชันการแสดงผล (Rendering - ใช้ KEY_MAP ที่กำหนดไว้)
        // =================================================================================================================================================
        
        /**
         * แปลงระดับการแจ้งเตือนเป็นสีและไอคอน (ใช้ sanitizeText เพื่อความแม่นยำภาษาไทย)
         */
        function getAlertStyles(alertLevel) {
            // ทำความสะอาด string ก่อนการเปรียบเทียบเพื่อให้แม่นยำแม้มีช่องว่างพิเศษ
            const sanitizedLevel = sanitizeText(alertLevel);
            
            // 1. วิกฤติ / อันตราย / ผิดปกติ / แจ้งเตือน (Red)
            if (sanitizedLevel.includes('วิกฤติ') || sanitizedLevel.includes('ผิดปกติ') || sanitizedLevel.includes('อันตราย') || sanitizedLevel.includes('แจ้งเตือน')) {
                return { color: 'bg-red-100 text-red-800 ring-red-300', icon: 'AlertTriangle', iconColor: 'text-red-500' };
            }
            
            // 2. เฝ้าระวัง / สูง (Amber/Yellow)
            if (sanitizedLevel.includes('เฝ้าระวัง') || sanitizedLevel.includes('สูง')) {
                // ใช้สี Amber สำหรับเฝ้าระวัง
                return { color: 'bg-amber-100 text-amber-800 ring-amber-300', icon: 'Eye', iconColor: 'text-amber-500' };
            }
            
            // 3. ปกติ / ทำงาน (Green)
            if (sanitizedLevel.includes('ปกติ') || sanitizedLevel.includes('ทำงาน')) {
                // ใช้สี Green สำหรับสถานะปกติและปั๊มที่กำลังทำงาน
                return { color: 'bg-green-100 text-green-800 ring-green-300', icon: 'CheckCircle', iconColor: 'text-green-500' };
            }
            
            // 4. ไม่ทำงาน (Indigo - Neutral operational state)
            if (sanitizedLevel.includes('ไม่ทำงาน')) {
                // ใช้สี Indigo สำหรับสถานะที่ไม่ทำงาน (Off/Standby)
                return { color: 'bg-indigo-100 text-indigo-800 ring-indigo-300', icon: 'PauseCircle', iconColor: 'text-indigo-500' };
            }

            // Default
            return { color: 'bg-gray-100 text-gray-800 ring-gray-300', icon: 'Info', iconColor: 'text-gray-500' };
        }

        /**
         * แปลงส่วนต่างระดับน้ำเป็นสีและไอคอนตามคำขอ (เพิ่ม = แดง, ลดลง = เขียว)
         */
        function getDiffIcon(diff) {
            const numDiff = parseFloat(diff);
            if (isNaN(numDiff)) return { icon: 'Minus', iconColor: 'text-gray-500' };

            if (numDiff > 0.001) {
                // เพิ่มขึ้น: สีแดง (สัญญาณเตือนความสูงของระดับน้ำ)
                return { icon: 'ArrowUp', iconColor: 'text-red-500' }; 
            } else if (numDiff < -0.001) {
                // ลดลง: สีเขียว (สัญญาณที่ดี/ปลอดภัยขึ้น)
                return { icon: 'ArrowDown', iconColor: 'text-green-500' }; 
            } else {
                return { icon: 'Minus', iconColor: 'text-gray-500' };
            }
        }

        /**
         * สร้างแถวตารางสำหรับข้อมูลระดับน้ำ (Sheet 1 & 2)
         */
        function createWaterTableRow(data) {
            // ใช้ KEY_MAP ที่กำหนดไว้แล้ว
            const alertLevel = data[KEY_MAP.ALERT_LEVEL] || 'N/A';
            const alertStyles = getAlertStyles(alertLevel);
            const diffValue = data[KEY_MAP.DIFF_LEVEL] || '0.00';
            const diffIcon = getDiffIcon(diffValue);

            return `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="p-4 whitespace-nowrap font-medium text-gray-900">
                        ${data[KEY_MAP.WATER_POINT] || 'N/A'} 
                    </td>
                    <td class="p-4 whitespace-nowrap text-lg font-bold text-gray-900">
                        ${data[KEY_MAP.CURRENT_LEVEL] || 'N/A'} ม.
                    </td>
                    <td class="p-4 whitespace-nowrap text-gray-600">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold ${diffIcon.iconColor}">
                                ${diffValue}
                            </span>
                            <i data-lucide="${diffIcon.icon}" class="w-4 h-4 ${diffIcon.iconColor}"></i>
                        </div>
                    </td>
                    <td class="p-4 whitespace-nowrap">
                        <span class="status-badge ${alertStyles.color} ring-1 ring-inset">
                             <i data-lucide="${alertStyles.icon}" class="w-3 h-3 mr-1"></i>
                            ${alertLevel}
                        </span>
                    </td>
                </tr>
            `;
        }
        
        /**
         * สร้างแถวตารางสำหรับข้อมูลสถานะปั๊ม (Sheet 3)
         */
        function createPumpTableRow(data) {
            // ใช้ KEY_MAP ที่กำหนดไว้แล้ว
            const pumpStatus = data[KEY_MAP.PUMP_STATUS] || 'ไม่พบสถานะ';
            const alertStyles = getAlertStyles(pumpStatus);
            const lastUpdate = data[KEY_MAP.LAST_UPDATE] || 'N/A';
            const dailyInspections = data[KEY_MAP.INSPECTIONS] || '0'; 

            return `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="p-4 whitespace-nowrap font-medium text-gray-900">
                        ${data[KEY_MAP.PUMP_STATION] || 'N/A'}
                    </td>
                    <td class="p-4 whitespace-nowrap">
                        <span class="status-badge ${alertStyles.color} ring-1 ring-inset">
                            <i data-lucide="${alertStyles.icon}" class="w-3 h-3 mr-1"></i>
                            ${pumpStatus}
                        </span>
                    </td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-500">
                        ${lastUpdate}
                    </td>
                    <td class="p-4 whitespace-nowrap text-sm font-semibold text-gray-700">
                        ${dailyInspections} ครั้ง
                    </td>
                </tr>
            `;
        }


        /**
         * อัปเดตส่วนแสดงผลระดับน้ำและเครื่องสูบน้ำ
         */
        function updateTable(elementId, data, rowCreator) {
            const tableBody = document.getElementById(elementId);
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // ล้างข้อมูลเก่า
            
            const isPumpTable = elementId === 'pump-status-table-body';
            const colSpan = isPumpTable ? 4 : 4; 
            
            // ตรวจสอบข้อมูล Error โดยอิงจากคีย์ที่ถูก sanitize แล้ว
            const checkKey = isPumpTable ? KEY_MAP.PUMP_STATION : KEY_MAP.CURRENT_LEVEL;

            if (data.length === 0 || (data.length > 0 && data[0]?.[checkKey]?.includes('Error'))) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="p-8 text-center text-red-500 bg-red-50/50">
                            <i data-lucide="CloudOff" class="w-6 h-6 mx-auto mb-2"></i>
                            ไม่สามารถดึงข้อมูลจาก Google Sheet ได้ กรุณาตรวจสอบ URL และสถานะการเผยแพร่ (Publish to the web)
                        </td>
                    </tr>
                `;
            } else {
                data.forEach(item => {
                    // ตรวจสอบว่าคีย์หลักของตารางปั๊มมีค่าหรือไม่
                    if (isPumpTable && !item[KEY_MAP.PUMP_STATION]) {
                         console.warn("Skipping row: Pump station name is missing or key mismatch.");
                         return; // ข้ามแถวที่คีย์หลักไม่ถูกต้อง
                    }
                    tableBody.innerHTML += rowCreator(item);
                });
            }

            lucide.createIcons();
        }
        
        // (updateDustboyCard และส่วนอื่นๆ ไม่เปลี่ยนแปลง)
        function updateDustboyCard(data) {
            const card = document.getElementById('dustboy-card');
            if (!card) return;

            const pm25Value = parseFloat(data.pm25);
            let bgColor = 'bg-green-600';
            let statusText = 'คุณภาพอากาศดีมาก';

            if (pm25Value > 75) {
                bgColor = 'bg-red-600';
                statusText = 'อันตราย (มีผลกระทบต่อสุขภาพ)';
            } else if (pm25Value > 50) {
                bgColor = 'bg-orange-600';
                statusText = 'เริ่มมีผลกระทบต่อสุขภาพ';
            } else if (pm25Value > 37) {
                bgColor = 'bg-yellow-600';
                statusText = 'คุณภาพอากาศปานกลาง';
            }
            
            const finalStatusText = data.status && data.status.length > 5 && !data.status.includes('จำลอง') ? data.status : statusText;

            card.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <i data-lucide="CloudDrizzle" class="w-8 h-8 text-white"></i>
                            <p class="text-white/75 text-sm">ค่าฝุ่น PM 2.5 ณ ${data.location}</p>
                        </div>
                        <span class="text-white text-4xl md:text-5xl font-extrabold leading-none">${data.pm25}</span>
                    </div>
                    <div class="mt-auto pt-4 border-t border-white/20">
                        <p class="text-white text-sm font-semibold">${finalStatusText}</p>
                        <p class="text-white/75 text-xs mt-1">อัปเดต: ${data.timestamp}</p>
                    </div>
                </div>
            `;
            card.className = `p-6 rounded-xl shadow-lg transition duration-500 ease-in-out transform hover:scale-[1.01] ${bgColor} text-white`;
            lucide.createIcons();
        }

        // =================================================================================================================================================
        // ส่วนที่ 5: ฟังก์ชันหลักในการอัปเดต Dashboard (ไม่เปลี่ยนแปลง)
        // =================================================================================================================================================

        let isUpdating = false;

        async function updateDashboard() {
            if (isUpdating) {
                console.log("Dashboard is currently updating. Skipping this interval.");
                return;
            }
            isUpdating = true;
            
            const lastUpdateTimeElement = document.getElementById('last-update-time');
            if (lastUpdateTimeElement) {
                lastUpdateTimeElement.textContent = 'กำลังอัปเดตข้อมูล...';
                lastUpdateTimeElement.classList.add('animate-pulse');
            }

            try {
                // 1. ดึงข้อมูลทั้งหมดพร้อมกัน (Parallel Fetching)
                const [
                    waterLevelData, 
                    chaoPhrayaData, 
                    pumpStatusData, 
                    dustboyData
                ] = await Promise.all([
                    fetchWaterLevelData(),
                    fetchChaoPhrayaData(),
                    fetchPumpStatusData(),
                    fetchDustboyData()
                ]);

                // 2. อัปเดตส่วนแสดงผล
                updateTable('water-level-table-body', waterLevelData, createWaterTableRow);
                updateTable('chaophraya-table-body', chaoPhrayaData, createWaterTableRow);
                updateTable('pump-status-table-body', pumpStatusData, createPumpTableRow);
                updateDustboyCard(dustboyData);
                
                // 3. อัปเดตเวลาล่าสุด
                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = `อัปเดตล่าสุด: ${timeString}`;
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                }
                document.getElementById('fetch-status').textContent = 'การอัปเดตสำเร็จ';

                console.log(`Dashboard updated successfully at ${timeString}`);

            } catch (error) {
                console.error("Critical error during dashboard update:", error);
                document.getElementById('fetch-status').textContent = 'เกิดข้อผิดพลาดในการดึงข้อมูล';
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = 'ไม่สามารถอัปเดตได้ (โปรดตรวจสอบ Console)';
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                    lastUpdateTimeElement.classList.add('text-red-500');
                }
            } finally {
                isUpdating = false;
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 6: การเริ่มต้น (Initialization - ไม่เปลี่ยนแปลง)
        // =================================================================================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Dashboard Initializing...");
            
            // 1. เรียกใช้งานครั้งแรก
            updateDashboard();

            // 2. ตั้งค่าการอัปเดตทุก 1 ชั่วโมง
            setInterval(updateDashboard, UPDATE_INTERVAL_MS);

            // 3. ผูกปุ่มรีเฟรช
            document.getElementById('refresh-button').addEventListener('click', updateDashboard);
        });

    </script>
    
    <!-- Header Section (คงความสูง) -->
    <header class="mb-6 flex-shrink-0">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">
                    Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม
                </h1>
                <p class="text-gray-500 mt-1">
                    ภาพรวมสถานการณ์ระดับน้ำ เครื่องสูบน้ำ และคุณภาพอากาศแบบเรียลไทม์
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <span id="last-update-time" class="text-sm font-medium text-gray-600 transition-all duration-500">
                    กำลังโหลด...
                </span>
                <button id="refresh-button" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    <i data-lucide="RefreshCw" class="w-4 h-4 mr-2"></i>
                    อัปเดตทันที
                </button>
            </div>
        </div>
        <div id="fetch-status" class="text-xs text-right text-gray-400 mt-2"></div>
    </header>

    <!-- Main Content Grid (กินพื้นที่ความสูงที่เหลือทั้งหมด) -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 main-content-area">
        
        <!-- Column 1: Water Level Monitoring (Sheet 1) & Dustboy API -->
        <div class="lg:col-span-2 flex flex-col space-y-6 h-full">
            
            <!-- Dustboy API Card (Fixed Height) -->
            <div id="dustboy-card" class="p-6 rounded-xl shadow-lg bg-gray-300 h-40 flex-shrink-0">
                <!-- Content will be injected by JavaScript -->
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-6 py-1">
                        <div class="h-2 bg-gray-200 rounded"></div>
                        <div class="space-y-3">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="h-2 bg-gray-200 rounded col-span-2"></div>
                                <div class="h-2 bg-gray-200 rounded col-span-1"></div>
                            </div>
                            <div class="h-2 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: ตรวจวัดระดับ (Sheet 1) - ใช้พื้นที่ที่เหลือทั้งหมด -->
            <div class="bg-white p-6 rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Gauge" class="w-5 h-5 mr-2 text-blue-600"></i>
                    สถานะการตรวจวัดระดับน้ำ (4 จุด - 4 รอบ/วัน)
                </h2>
                <!-- Scrollable Table Container -->
                <div class="overflow-y-auto flex-grow -mx-6 px-6"> <!-- -mx-6, px-6 เพื่อขยายตารางให้เต็มความกว้าง Card -->
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    จุดวัด
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ระดับน้ำปัจจุบัน
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ส่วนต่าง (เทียบครั้งก่อน)
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ระดับการแจ้งเตือน
                                </th>
                            </tr>
                        </thead>
                        <tbody id="water-level-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Column 2: Chao Phraya Level (Sheet 2) & Pump Status (Sheet 3) -->
        <div class="lg:col-span-1 flex flex-col space-y-6 h-full">
            
            <!-- Card: ระดับน้ำเจ้าพระยา (Sheet 2) -->
            <div class="bg-white p-6 rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Waves" class="w-5 h-5 mr-2 text-teal-600"></i>
                    ข้อมูลระดับน้ำเจ้าพระยา (4 จุด - 3 รอบ/วัน)
                </h2>
                <!-- Scrollable Table Container -->
                 <div class="overflow-y-auto flex-grow -mx-6 px-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    จุดวัด
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ระดับน้ำ
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ส่วนต่าง
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    แจ้งเตือน
                                </th>
                            </tr>
                        </thead>
                        <tbody id="chaophraya-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card: สถานะปั๊ม (Sheet 3) -->
            <div class="bg-white p-6 rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Box" class="w-5 h-5 mr-2 text-indigo-600"></i>
                    การตรวจสอบเครื่องสูบน้ำ (14 สถานี)
                </h2>
                <!-- Scrollable Table Container -->
                <div class="overflow-y-auto flex-grow -mx-6 px-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    สถานี
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    สถานะ
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    เวลาล่าสุด
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    การตรวจต่อวัน
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pump-status-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <footer class="mt-4 flex-shrink-0 text-center text-sm text-gray-400">
        <p>Dashboard Powered by Gemini and deployed on GitHub Pages.</p>
        <p class="mt-1 font-semibold text-gray-600">
            โปรดจำไว้ว่าคุณต้องแทนที่ URL ตัวอย่างในโค้ดด้วยลิงก์ Google Sheet ที่เผยแพร่แล้ว และ Dustboy API จริง
        </p>
    </footer>

</body>
</html>
