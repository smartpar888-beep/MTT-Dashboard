<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- D3.js CDN for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    
    <style>
        /* กำหนดฟอนต์ Inter สำหรับ Tailwind (แนะนำสำหรับ UI) */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Style for alert status badges: Adjusted font size for larger table */
        .status-badge {
            padding: 0.4rem 0.8rem; /* เพิ่ม padding */
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem; /* เพิ่มขนาดตัวอักษรสำหรับ Badge */
            display: inline-flex;
            align-items: center;
        }
        
        /* CSS เพื่อให้พอดีหน้าจอ 100% (Full Screen) */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        .full-screen-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1.5rem; 
            overflow: hidden; 
        }
        
        /* ให้ Main Content ใช้พื้นที่ที่เหลือทั้งหมด และสามารถเลื่อนได้ */
        .main-content-scroll {
            overflow-y: auto;
            flex-grow: 1;
        }

        /* สำหรับกราฟ: ซ่อนแกน Y ของ D3 เพื่อไม่ให้มีปัญหาเรื่องภาษา*/
        #rainfall-chart-container text {
            font-family: 'Inter', sans-serif;
        }
        
    </style>
</head>
<body class="bg-gray-50 full-screen-container">
    
    <script>
        // =================================================================================================================================================
        // ส่วนที่ 1: การกำหนดค่าและ URL ของแหล่งข้อมูล
        // =================================================================================================================================================
        
        // *************************************************************************************************************************************************
        // ** สำคัญ: กรุณาแทนที่ URL ตัวอย่างเหล่านี้ด้วย URL จริงของ Google Sheets ที่คุณเผยแพร่เป็น CSV **
        // *************************************************************************************************************************************************
        const GOOGLE_SHEET_URL_1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT452CdpcF_hoA-_x3a6Ji0YKeWTuSr_9CM0We83aAAPiBWMRoHrKEujaYtEzHMZYMLEL8wKa10NPYF/pub?gid=675852265&single=true&output=csv"; // ตรวจวัดระดับ
        const GOOGLE_SHEET_URL_2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5OYSm3Hn1V4kegJf9x3iK2OGvUIL7vbnWryNUsx15VCm4NdxoVoWZMx1vWTlKcZskeD-YYjhbKn2V/pub?gid=202563025&single=true&output=csv"; // ข้อมูลระดับน้ำเจ้าพระยา
        const GOOGLE_SHEET_URL_3 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyPcfGQReUPOHckF-6bA4UOucC8cbqRvHj-aTP7uWRkBjvQ4HrieGIhcet4OH9O0DjT_M2FM3QaaV9/pub?gid=273571070&single=true&output=csv"; // ข้อมูลการตรวจสอบการทำงานของเครื่องสูบน้ำ
        const GOOGLE_SHEET_URL_4 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5qwzKbaRjpA3iUXbyNMg9Y0tYdlVwykSAxz1V_CxMoT6PwnmMZjKvSNR2PpSWFjwbr9aG8uIU23tN/pub?gid=77454851&single=true&output=csv"; // ข้อมูลปริมาณน้ำฝน 
        
        // ระยะเวลาการอัปเดต: 1 ชั่วโมง = 3600000 มิลลิวินาที
        const UPDATE_INTERVAL_MS = 3600000;

        // =================================================================================================================================================
        // ส่วนที่ 2: การกำหนดค่าชื่อคอลัมน์ (USER CONFIGURATION) และ KEY MAP
        // =================================================================================================================================================
        
        /**
         * *** สำคัญ: กรุณาใส่ชื่อคอลัมน์ EXACTLY ตามที่ปรากฏใน Google Sheet ของคุณ ***
         * (หากคอลัมน์ใน Sheet คือ "ระดับน้ำ ปัจจุบัน" ให้ใส่ "ระดับน้ำ ปัจจุบัน")
         */
        const USER_COLUMN_NAMES = {
            SHEET_1_2: {
                POINT: 'จุดวัด',                 // ชื่อคอลัมน์ใน Sheet 1 และ 2 สำหรับจุดวัด
                LEVEL: 'ระดับน้ำปัจจุบัน',       // ชื่อคอลัมน์สำหรับระดับน้ำ
                DIFF: 'ส่วนต่างระดับน้ำ',         // ชื่อคอลัมน์สำหรับส่วนต่าง
                ALERT: 'ระดับการแจ้งเตือน',       // ชื่อคอลัมน์สำหรับระดับแจ้งเตือน
            },
            SHEET_3: {
                STATION: 'สถานีสูบน้ำ',           // ชื่อคอลัมน์ใน Sheet 3 สำหรับสถานีสูบน้ำ
                STATUS: 'สถานะปั๊ม',             // ชื่อคอลัมน์สำหรับสถานะปั๊ม
                UPDATE: 'เวลาล่าสุด',             // ชื่อคอลัมน์สำหรับเวลาอัปเดต
                INSPECTIONS: 'จำนวนครั้งการเข้าตรวจ', // คอลัมน์สำหรับจำนวนครั้งที่เข้าตรวจ (ใช้ใน Modal)
            },
             SHEET_4: {
                POINT: 'จุดวัดประมาณน้ำฝน',     // ชื่อคอลัมน์ใน Sheet 4 สำหรับจุดวัด
                AMOUNT: 'ปริมาณน้ำฝน',          // ชื่อคอลัมน์สำหรับปริมาณน้ำฝน (ใช้ทำ Bar Chart)
                DURATION: 'ระยะเวลาฝนตก',       // ชื่อคอลัมน์สำหรับระยะเวลาฝนตก (ใช้ทำ Card)
            }
        };

        /**
         * ทำความสะอาดข้อความ โดยการลบช่องว่างทั้งหมด (รวมถึงช่องว่างที่ซ่อนอยู่)
         * @param {string} text - ข้อความที่ต้องการทำความสะอาด
         * @returns {string} ข้อความที่ถูกทำความสะอาดแล้ว
         */
        function sanitizeText(text) {
            if (!text) return '';
            // ลบช่องว่าง (Space), Newline/Tab, และอักขระ BOM ออกทั้งหมด
            return text.trim().replace(/\s+/g, '').replace(/\uFEFF/g, '');
        }

        /**
         * แผนที่คีย์มาตรฐานที่ใช้ในการดึงข้อมูลจาก Array Object 
         * ใช้ค่าจาก USER_COLUMN_NAMES ที่ถูก sanitize แล้ว
         */
        const KEY_MAP = {
            // Keys for Water Level (Sheet 1 & 2)
            WATER_POINT: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.POINT), 
            CURRENT_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEAT_1_2.LEVEL),
            DIFF_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.DIFF),
            ALERT_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.ALERT),

            // Keys for Pump Status (Sheet 3)
            PUMP_STATION: sanitizeText(USER_COLUMN_NAMES.SHEET_3.STATION),
            PUMP_STATUS: sanitizeText(USER_COLUMN_NAMES.SHEET_3.STATUS),
            LAST_UPDATE: sanitizeText(USER_COLUMN_NAMES.SHEET_3.UPDATE),
            INSPECTIONS: sanitizeText(USER_COLUMN_NAMES.SHEET_3.INSPECTIONS), 
            
            // Keys for Rainfall (Sheet 4) 
            RAIN_POINT: sanitizeText(USER_COLUMN_NAMES.SHEET_4.POINT), 
            RAIN_AMOUNT: sanitizeText(USER_COLUMN_NAMES.SHEET_4.AMOUNT),
            RAIN_DURATION: sanitizeText(USER_COLUMN_NAMES.SHEET_4.DURATION),
        };

        /**
         * ฟังก์ชันแปลง CSV string เป็น Array of Objects
         */
        function csvToArray(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const cleanHeaders = rawHeaders.map(h => sanitizeText(h)); 
            
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentLine = lines[i];
                
                // ใช้ Regular Expression เพื่อจัดการค่าที่มี comma ภายในเครื่องหมายคำพูด
                // This is a basic split and might need adjustment if data is complex
                const values = currentLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                
                if (values.length === cleanHeaders.length) {
                    let hasRequiredKey = false;
                    for (let j = 0; j < cleanHeaders.length; j++) {
                        obj[cleanHeaders[j]] = values[j]; 
                        // ตรวจสอบว่ามีคอลัมน์ที่จำเป็นสำหรับแสดงผลไหม (Water Point, Pump Station, หรือ Rain Point)
                        if (cleanHeaders[j] === KEY_MAP.WATER_POINT || cleanHeaders[j] === KEY_MAP.PUMP_STATION || cleanHeaders[j] === KEY_MAP.RAIN_POINT) {
                             hasRequiredKey = true;
                        }
                    }
                    
                    if (hasRequiredKey) {
                         result.push(obj);
                    }
                } else {
                    console.warn(`[Parsing Error] Skipping data line ${i+1}: Column count mismatch (${values.length} found, ${cleanHeaders.length} expected).`);
                }
            }
            return result;
        }

        /**
         * ฟังก์ชันหลักในการดึงข้อมูลจาก Google Sheet (CSV) 
         */
        async function fetchDataFromSheet(url) {
            console.log(`[INFO] Attempting to fetch data from URL: ${url}`);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${url}`);
                }
                const csvText = await response.text();
                return csvToArray(csvText);
            } catch (error) {
                console.error("Error fetching or parsing sheet data:", error);
                // ส่งข้อมูล Error ที่จะถูกจับใน updateTable
                return [
                    { 'ERROR_KEY': 'N/A (Error)', [KEY_MAP.ALERT_LEVEL]: 'ไม่ได้เชื่อมต่อ' },
                ];
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 3: ฟังก์ชันดึงข้อมูลเฉพาะสำหรับแต่ละแหล่ง
        // =================================================================================================================================================

        async function fetchWaterLevelData() {
            return fetchDataFromSheet(GOOGLE_SHEET_URL_1);
        }

        async function fetchChaoPhrayaData() {
            return fetchDataFromSheet(GOOGLE_SHEET_URL_2);
        }

        async function fetchPumpStatusData() {
            return fetchDataFromSheet(GOOGLE_SHEET_URL_3);
        }

        async function fetchRainfallData() {
            return fetchDataFromSheet(GOOGLE_SHEET_URL_4); 
        }
        
        // =================================================================================================================================================
        // ส่วนที่ 4: ฟังก์ชันการแสดงผล (Rendering)
        // =================================================================================================================================================
        
        /**
         * แปลงระดับการแจ้งเตือนเป็นสีและไอคอน
         */
        function getAlertStyles(alertLevel) {
            const sanitizedLevel = sanitizeText(alertLevel);
            
            if (sanitizedLevel.includes('วิกฤติ') || sanitizedLevel.includes('ผิดปกติ') || sanitizedLevel.includes('อันตราย') || sanitizedLevel.includes('แจ้งเตือน')) {
                return { color: 'bg-red-100 text-red-800 ring-red-300', icon: 'AlertTriangle', iconColor: 'text-red-500' };
            }
            
            if (sanitizedLevel.includes('เฝ้าระวัง') || sanitizedLevel.includes('สูง')) {
                return { color: 'bg-amber-100 text-amber-800 ring-amber-300', icon: 'Eye', iconColor: 'text-amber-500' };
            }
            
            if (sanitizedLevel.includes('ปกติ') || sanitizedLevel.includes('ทำงาน')) {
                return { color: 'bg-green-100 text-green-800 ring-green-300', icon: 'CheckCircle', iconColor: 'text-green-500' };
            }
            
            if (sanitizedLevel.includes('ไม่ทำงาน')) {
                return { color: 'bg-indigo-100 text-indigo-800 ring-indigo-300', icon: 'PauseCircle', iconColor: 'text-indigo-500' };
            }

            return { color: 'bg-gray-100 text-gray-800 ring-gray-300', icon: 'Info', iconColor: 'text-gray-500' };
        }

        /**
         * แปลงส่วนต่างระดับน้ำเป็นสีและไอคอน
         */
        function getDiffIcon(diff) {
            const numDiff = parseFloat(diff);
            if (isNaN(numDiff)) return { icon: 'Minus', iconColor: 'text-gray-500' };

            if (numDiff > 0.001) {
                return { icon: 'ArrowUp', iconColor: 'text-red-500' }; 
            } else if (numDiff < -0.001) {
                return { icon: 'ArrowDown', iconColor: 'text-green-500' }; 
            } else {
                return { icon: 'Minus', iconColor: 'text-gray-500' };
            }
        }

        /**
         * สร้างแถวตารางสำหรับข้อมูลระดับน้ำ (Sheet 1 & 2)
         * Sheet 1: ปรับขนาดตัวอักษรเป็น 2 เท่า
         */
        function createWaterTableRow(data, isSheet1 = false) {
            const alertLevel = data[KEY_MAP.ALERT_LEVEL] || 'N/A';
            const alertStyles = getAlertStyles(alertLevel);
            const diffValue = data[KEY_MAP.DIFF_LEVEL] || '0.00';
            const diffIcon = getDiffIcon(diffValue);

            const currentLevelValue = data[KEY_MAP.CURRENT_LEVEL];
            const displayLevel = currentLevelValue || 'N/A';
            
            const pointName = data[KEY_MAP.WATER_POINT] || '';
            let unit = 'รทก./MSL.'; 

            // Logic เพื่อกำหนดหน่วยสำหรับ Sheet 2 (Chao Phraya)
            if (pointName.includes('เขื่อนเจ้าพระยา')) {
                unit = 'ลบ.ม./วินาที';
            } 
            
            if (displayLevel === 'N/A') {
                unit = '';
            }

            // Adjust size based on isSheet1 flag
            const baseTextSize = isSheet1 ? 'text-xl' : 'text-sm';
            const largeTextSize = isSheet1 ? 'text-2xl' : 'text-lg';
            const iconSize = isSheet1 ? 'w-6 h-6' : 'w-4 h-4';
            const badgeIconSize = isSheet1 ? 'w-4 h-4' : 'w-3 h-3';
            const badgeTextSize = isSheet1 ? 'text-base' : 'text-xs';

            return `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="p-4 whitespace-nowrap font-medium ${baseTextSize} text-gray-900">
                        ${data[KEY_MAP.WATER_POINT] || 'N/A'} 
                    </td>
                    <td class="p-4 whitespace-nowrap ${largeTextSize} font-bold text-gray-900">
                        ${displayLevel} ${unit}
                    </td>
                    <td class="p-4 whitespace-nowrap ${baseTextSize} text-gray-600">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold ${diffIcon.iconColor}">
                                ${diffValue}
                            </span>
                            <i data-lucide="${diffIcon.icon}" class="${iconSize} ${diffIcon.iconColor}"></i>
                        </div>
                    </td>
                    <td class="p-4 whitespace-nowrap">
                        <span class="status-badge ${alertStyles.color} ring-1 ring-inset ${badgeTextSize}">
                             <i data-lucide="${alertStyles.icon}" class="${badgeIconSize} mr-1"></i>
                            ${alertLevel}
                        </span>
                    </td>
                </tr>
            `;
        }
        
        /**
         * สร้าง Card สำหรับข้อมูลสถานะปั๊ม (Sheet 3)
         */
        function createPumpStatusCard(data) {
            const pumpStation = data[KEY_MAP.PUMP_STATION] || 'N/A';
            const pumpStatus = data[KEY_MAP.PUMP_STATUS] || 'ไม่พบสถานะ';
            
            const inspectionCount = data[KEY_MAP.INSPECTIONS] || '0'; 
            
            const sanitizedStatus = sanitizeText(pumpStatus);

            let bgColor = 'bg-gray-100';
            let textColor = 'text-gray-800';
            let icon = 'Info';

            // Color Logic
            if (sanitizedStatus.includes('ปกติ') || sanitizedStatus.includes('ทำงาน')) {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                icon = 'CheckCircle';
            } else if (sanitizedStatus.includes('ผิดปกติ') || sanitizedStatus.includes('วิกฤติ') || sanitizedStatus.includes('ไม่ทำงาน') || sanitizedStatus.includes('แจ้งเตือน')) {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                icon = 'AlertTriangle';
            } else {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
                icon = 'Eye';
            }

            const safeStationName = pumpStation.replace(/'/g, "\\'");
            const safeInspectionCount = inspectionCount.replace(/'/g, "\\'");
            
            // ปรับเปลี่ยน width: w-full บนมือถือ, w-[calc(50%-0.25rem)] บน MD/LG, w-full บน XL (ในกริด 2 คอลัมน์)
            return `
                <div 
                    class="p-3 ${bgColor} rounded-lg shadow-sm ring-1 ring-inset ring-opacity-50 flex items-start space-x-2 transition duration-200 hover:ring-2 hover:ring-offset-2 hover:ring-opacity-100 cursor-pointer w-full sm:w-[calc(50%-0.25rem)] lg:w-full"
                    onclick="showInspectionModal('${safeStationName}', '${safeInspectionCount}')"
                >
                    <i data-lucide="${icon}" class="w-4 h-4 mt-1 ${textColor} flex-shrink-0"></i> 
                    <div class="flex flex-col min-w-0"> 
                        <span class="text-sm font-semibold ${textColor} truncate">
                            ${pumpStation}
                        </span>
                        <span class="text-[11px] ${textColor} opacity-85 mt-[-2px] truncate">
                            ${pumpStatus}
                        </span>
                    </div>
                </div>
            `;
        }

        /**
         * แสดง Modal สำหรับจำนวนครั้งการเข้าตรวจ
         */
        function showInspectionModal(stationName, inspectionCount) {
            const modal = document.getElementById('inspection-modal');
            const stationNameElement = document.getElementById('modal-station-name');
            const inspectionCountElement = document.getElementById('modal-inspection-count');

            if (modal && stationNameElement && inspectionCountElement) {
                stationNameElement.textContent = stationName;
                inspectionCountElement.textContent = inspectionCount; 
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        /**
         * ซ่อน Modal สำหรับจำนวนครั้งการเข้าตรวจ
         */
        function closeInspectionModal() {
            const modal = document.getElementById('inspection-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        /**
         * แสดงข้อความ Error และคำแนะนำในการแก้ไขปัญหาสำหรับ Sheet 4
         */
        function displaySheet4Error(containerId, data) {
            const container = document.querySelector(containerId);
            const isUrlPlaceholder = GOOGLE_SHEET_URL_4.includes('{SHEET_ID_4}');
            
            let message = '';
            let details = '';
            let title = '';

            if (isUrlPlaceholder) {
                 title = "❗ ไม่ได้ระบุ URL ของ Sheet 4";
                 message = "กรุณาแทนที่ GOOGLE_SHEET_URL_4 ด้วย Link CSV ที่เผยแพร่แล้วของท่าน";
                 details = `URL ปัจจุบัน: ${GOOGLE_SHEET_URL_4}`;
            } else if (data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'))) {
                 title = "❌ ไม่สามารถโหลดข้อมูล Sheet 4 ได้";
                 message = "กรุณาตรวจสอบว่า Google Sheet ได้ถูก 'เผยแพร่ไปยังเว็บ' (Publish to web) เป็น CSV และ URL ถูกต้อง";
                 details = `
                    <p class="mt-2 text-sm text-red-700 font-medium">ข้อกำหนดชื่อคอลัมน์:</p>
                    <ul class="list-disc list-inside ml-4 text-xs">
                        <li>จุดวัด: <strong>${USER_COLUMN_NAMES.SHEET_4.POINT}</strong> (ใช้สำหรับแกน X)</li>
                        <li>ปริมาณ: <strong>${USER_COLUMN_NAMES.SHEET_4.AMOUNT}</strong> (ใช้สำหรับแกน Y)</li>
                        <li>ระยะเวลา: <strong>${USER_COLUMN_NAMES.SHEET_4.DURATION}</strong> (ใช้สำหรับ Card)</li>
                    </ul>
                 `;
            } else {
                 // No error, but no valid chart data after parsing
                 title = "⚠️ ข้อมูลไม่พร้อมใช้งานสำหรับกราฟ";
                 message = "ข้อมูลที่ได้รับไม่พบค่า 'ปริมาณน้ำฝน' ที่เป็นตัวเลข หรือ 'จุดวัดประมาณน้ำฝน' ที่ถูกต้อง";
                 details = "โปรดตรวจสอบข้อมูลดิบใน Sheet ว่ามีตัวเลขและชื่อจุดวัดที่ครบถ้วนหรือไม่";
            }
            
            // Generate the error card HTML
            container.innerHTML = `
                <div class="p-8 text-center bg-red-50/50 rounded-lg border border-red-300">
                    <h3 class="text-xl font-bold text-red-800 mb-2">${title}</h3>
                    <p class="text-red-700">${message}</p>
                    <div class="mt-4 p-3 bg-red-100 rounded-md text-left">
                        <p class="font-semibold text-red-800">รายละเอียด:</p>
                        <pre class="text-xs whitespace-pre-wrap">${details}</pre>
                    </div>
                </div>
            `;
        }

        /**
         * สร้าง Card สำหรับระยะเวลาฝนตก (Sheet 4) 
         */
        function createRainDurationCard(data) {
            const container = document.getElementById('rain-duration-card-container');
            if (!container) return;

            const isFetchError = data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'));
            
            let duration = 'N/A';
            if (!isFetchError && data.length > 0) {
                // พยายามดึงข้อมูลจากแถวแรก
                duration = data[0][KEY_MAP.RAIN_DURATION] || 'N/A';
            }

            const durationDisplay = parseFloat(duration).toFixed(0);
            const isValidDuration = !isNaN(parseFloat(duration));
            
            const displayValue = isValidDuration ? durationDisplay : 'N/A';
            const bgColor = isValidDuration ? 'bg-sky-500' : 'bg-gray-400';
            const icon = isValidDuration ? 'Clock' : 'AlertOctagon';
            const shadow = isValidDuration ? 'shadow-lg shadow-sky-500/50' : 'shadow-md';

            const cardHtml = `
                <div class="w-48 p-4 ${bgColor} text-white rounded-xl ${shadow} transition duration-300">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium opacity-80">ระยะเวลาฝนตก</span>
                        <i data-lucide="${icon}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex items-end justify-start space-x-1">
                        <span class="text-4xl font-extrabold leading-none">
                            ${displayValue}
                        </span>
                        <span class="text-lg font-bold leading-tight pb-0.5">
                            นาที
                        </span>
                    </div>
                </div>
            `;

            container.innerHTML = cardHtml;
            lucide.createIcons();
        }
        
        /**
         * วาดกราฟแท่งปริมาณน้ำฝนโดยใช้ D3.js (Sheet 4) 
         */
        function drawRainfallBarChart(data) {
            const containerId = '#rainfall-chart-container';
            const container = document.querySelector(containerId);
            
            // ล้าง SVG เก่า
            d3.select(containerId).select("svg").remove();

            // 1. ตรวจสอบ Error / Placeholder
            const isUrlPlaceholder = GOOGLE_SHEET_URL_4.includes('{SHEET_ID_4}');
            const isFetchError = data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'));

            if (isUrlPlaceholder || isFetchError) {
                // Display prominent error message using the helper function
                displaySheet4Error(containerId, data);
                return;
            }

            // 2. เตรียมข้อมูล
            const chartData = data
                .map(d => ({
                    point: d[KEY_MAP.RAIN_POINT] || 'N/A',
                    amount: parseFloat(d[KEY_MAP.RAIN_AMOUNT])
                }))
                .filter(d => !isNaN(d.amount) && d.point !== 'N/A' && d.amount >= 0);

            if (chartData.length === 0) {
                 // Display specific error if data was fetched but is invalid for charting
                 displaySheet4Error(containerId, data);
                 return;
            }
            
            // 3. กำหนดขนาดและขอบเขต
            const margin = { top: 20, right: 30, bottom: 80, left: 60 };
            
            // ใช้ขนาดของ Container ปัจจุบัน
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            const width = Math.max(containerWidth - margin.left - margin.right, 300);
            const height = Math.max(containerHeight - margin.top - margin.bottom, 300);

            // 4. สร้าง SVG Element
            const svg = d3.select(containerId)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
                
            // 5. กำหนด Scale
            // Scale X (ชื่อจุดวัด - Categorical)
            const x = d3.scaleBand()
                .domain(chartData.map(d => d.point))
                .range([0, width])
                .padding(0.3);

            // Scale Y (ปริมาณน้ำฝน - Linear)
            const y = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.amount) * 1.1]) 
                .range([height, 0]);

            // 6. วาด Axis
            // X-Axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)") // เอียงชื่อจุดวัด
                .style("text-anchor", "end")
                .style("font-size", "12px");

            // Y-Axis
            svg.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .style("font-size", "12px");

            // Y-Axis Label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 5)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .style("fill", "#4b5563")
                .text("ปริมาณน้ำฝน (มม.)"); 

            // 7. วาด Bar
            svg.selectAll(".bar")
                .data(chartData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.point))
                .attr("y", height) 
                .attr("width", x.bandwidth())
                .attr("height", 0) 
                .attr("fill", "#0ea5e9") // sky-500
                .attr("rx", 4) // Rounded corners
                .transition() 
                .duration(800)
                .delay((d, i) => i * 100)
                .attr("y", d => y(d.amount))
                .attr("height", d => height - y(d.amount));
                
            // 8. เพิ่ม Text Label บน Bar
            svg.selectAll(".label")
                .data(chartData)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => x(d.point) + x.bandwidth() / 2)
                .attr("y", d => y(d.amount))
                .attr("dy", "-0.5em") 
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("font-weight", "bold")
                .style("fill", "#1e293b") 
                .text(d => d.amount.toFixed(2));
                
            // Optional: Add resize listener for responsiveness (Simple approach)
            function handleResize() {
                // Redraw chart completely on resize (simple, but effective)
                if (container.clientWidth > 0 && container.clientHeight > 0) {
                    drawRainfallBarChart(data);
                }
            }
            window.removeEventListener('resize', handleResize);
            window.addEventListener('resize', handleResize);
        }

        /**
         * อัปเดตส่วนแสดงผลระดับน้ำและเครื่องสูบน้ำ
         */
        function updateTable(elementId, data) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.innerHTML = ''; // ล้างข้อมูลเก่า
            
            const isSheet1 = elementId === 'water-level-table-body';
            const isSheet2 = elementId === 'chaophraya-table-body';
            const isPumpCardContainer = elementId === 'pump-status-card-container';
            
            // ตรวจสอบคีย์หลัก
            const checkKey = isPumpCardContainer ? KEY_MAP.PUMP_STATION : KEY_MAP.WATER_POINT;
            
            // ตรวจสอบข้อมูล Error ทั่วไป
            const isError = data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'));

            if (isError) {
                // ข้อความแจ้งเตือนสำหรับตาราง/การ์ดอื่น
                const errorMessage = 'ไม่สามารถดึงข้อมูลจาก Google Sheet ได้ กรุณาตรวจสอบ URL, สถานะการเผยแพร่ และชื่อคอลัมน์';
                
                if (!isPumpCardContainer) { 
                    const colSpan = 4;
                    container.innerHTML = `
                        <tr>
                            <td colspan="${colSpan}" class="p-8 text-center text-red-500 bg-red-50/50">
                                <i data-lucide="CloudOff" class="w-6 h-6 mx-auto mb-2"></i>
                                ${errorMessage}
                            </td>
                        </tr>
                    `;
                } else {
                    // สำหรับ Card Container (Pump Status - div)
                    container.innerHTML = `
                        <div class="w-full p-4 text-center text-red-500 bg-red-50/50 rounded-lg">
                            <i data-lucide="CloudOff" class="w-6 h-6 mx-auto mb-2"></i>
                            ${errorMessage}
                        </div>
                    `;
                }
            } else {
                // Render data
                data.forEach(item => {
                    if (checkKey && !item[checkKey]) {
                         console.warn(`Skipping row: Key '${checkKey}' is missing in sheet data. Check column names.`);
                         return; 
                    }
                    if (isPumpCardContainer) {
                        container.innerHTML += createPumpStatusCard(item);
                    } else if (isSheet1 || isSheet2) {
                        container.innerHTML += createWaterTableRow(item, isSheet1); // Pass isSheet1 flag
                    }
                });
            }

            lucide.createIcons();
        }

        // =================================================================================================================================================
        // ส่วนที่ 5: ฟังก์ชันหลักในการอัปเดต Dashboard
        // =================================================================================================================================================

        let isUpdating = false;

        async function updateDashboard() {
            if (isUpdating) {
                return;
            }
            isUpdating = true;
            
            const lastUpdateTimeElement = document.getElementById('last-update-time');
            if (lastUpdateTimeElement) {
                lastUpdateTimeElement.textContent = 'กำลังอัปเดตข้อมูล...';
                lastUpdateTimeElement.classList.add('animate-pulse');
            }

            try {
                // 1. ดึงข้อมูลทั้งหมดพร้อมกัน
                const [
                    waterLevelData, 
                    chaoPhrayaData, 
                    pumpStatusData,
                    rainfallData
                ] = await Promise.all([
                    fetchWaterLevelData(),
                    fetchChaoPhrayaData(),
                    fetchPumpStatusData(),
                    fetchRainfallData() 
                ]);

                // 2. อัปเดตส่วนแสดงผล
                updateTable('water-level-table-body', waterLevelData); // Sheet 1
                updateTable('chaophraya-table-body', chaoPhrayaData); // Sheet 2
                updateTable('pump-status-card-container', pumpStatusData); // Sheet 3
                
                // อัปเดตส่วนปริมาณน้ำฝน (Sheet 4)
                createRainDurationCard(rainfallData);
                drawRainfallBarChart(rainfallData);
                
                // 3. อัปเดตเวลาล่าสุด
                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = `อัปเดตล่าสุด: ${timeString}`;
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                    lastUpdateTimeElement.classList.remove('text-red-500'); // ลบสีแดงเมื่ออัปเดตสำเร็จ
                }

            } catch (error) {
                console.error("Critical error during dashboard update:", error);
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = 'ไม่สามารถอัปเดตได้ (โปรดตรวจสอบ Console)';
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                    lastUpdateTimeElement.classList.add('text-red-500');
                }
            } finally {
                isUpdating = false;
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 6: การเริ่มต้น (Initialization)
        // =================================================================================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            setInterval(updateDashboard, UPDATE_INTERVAL_MS);
            document.getElementById('refresh-button').addEventListener('click', updateDashboard);
            
            document.getElementById('inspection-modal').addEventListener('click', (event) => {
                if (event.target.id === 'inspection-modal' || event.target.closest('#modal-close-button')) {
                    closeInspectionModal();
                }
            });
        });

    </script>
    
    <!-- Header Section -->
    <header class="mb-6 flex-shrink-0">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">
                    Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม
                </h1>
                <p class="text-gray-500 mt-1">
                    ภาพรวมสถานการณ์ระดับน้ำ และเครื่องสูบน้ำแบบเรียลไทม์
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <span id="last-update-time" class="text-sm font-medium text-gray-600 transition-all duration-500">
                    กำลังโหลด...
                </span>
                <button id="refresh-button" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    <i data-lucide="RefreshCw" class="w-4 h-4 mr-2"></i>
                    อัปเดตทันที
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content Container with Scrolling -->
    <div class="main-content-scroll">
        <!-- Main Content Grid (1 Column on Mobile, 2 Columns on MD+) -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- 1. Sheet URL 1: สถานะการตรวจวัดระดับ (Top Left) -->
            <div class="order-1 bg-white p-6 rounded-xl shadow-md flex flex-col overflow-hidden h-full min-h-[400px]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Gauge" class="w-5 h-5 mr-2 text-blue-600"></i>
                    สถานะการตรวจวัดระดับน้ำ (4 จุด - 4 รอบ/วัน)
                </h2>
                <!-- Scrollable Table Container -->
                <div class="overflow-x-auto flex-grow -mx-6 px-6"> 
                    <!-- table-auto เพื่อปรับความกว้างให้พอดีข้อความ -->
                    <table class="table-auto divide-y divide-gray-200"> 
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <!-- whitespace-nowrap เพื่อไม่ให้ข้อความหัวตารางแตกบรรทัด -->
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    จุดวัด
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    ระดับน้ำปัจจุบัน
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    ส่วนต่าง (เทียบครั้งก่อน)
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    ระดับการแจ้งเตือน
                                </th>
                            </tr>
                        </thead>
                        <tbody id="water-level-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Sheet URL 2: ระดับน้ำเจ้าพระยา (Top Right) -->
            <div class="order-2 bg-white p-6 rounded-xl shadow-md flex flex-col overflow-hidden flex-shrink-0 min-h-[400px]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Waves" class="w-5 h-5 mr-2 text-teal-600"></i>
                    ข้อมูลระดับน้ำเจ้าพระยา (4 จุด - 3 รอบ/วัน)
                </h2>
                <!-- Scrollable Table Container -->
                <div class="overflow-y-auto flex-grow -mx-6 px-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    จุดวัด
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    ระดับน้ำ
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    ส่วนต่าง
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    แจ้งเตือน
                                </th>
                            </tr>
                        </thead>
                        <tbody id="chaophraya-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 3. Sheet URL 4: ปริมาณและระยะเวลาฝนตก (Bottom Left) -->
            <div class="order-3 bg-white p-6 rounded-xl shadow-md flex flex-col min-h-[450px]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="CloudRain" class="w-5 h-5 mr-2 text-sky-600"></i>
                    ปริมาณและระยะเวลาฝนตก (มม.)
                </h2>
                <div class="relative flex-grow min-h-[400px]">
                    <!-- Rain Duration Card (Top Right) -->
                    <div id="rain-duration-card-container" class="absolute top-0 right-0 z-20">
                        <!-- Card will be injected here -->
                    </div>
                    <!-- Bar Chart Container: pt-16 เพื่อเว้นพื้นที่ให้ Card ด้านบน -->
                    <div id="rainfall-chart-container" class="w-full h-full pt-16"> 
                        <!-- Chart will be drawn here, or error message will be displayed -->
                    </div>
                </div>
            </div>


            <!-- 4. Sheet URL 3: สถานะเครื่องสูบน้ำ (Bottom Right) -->
            <div class="order-4 bg-white p-6 rounded-xl shadow-md flex-grow flex flex-col min-h-[450px]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                    <i data-lucide="Box" class="w-5 h-5 mr-2 text-indigo-600"></i>
                    สถานะเครื่องสูบน้ำ (14 สถานี)
                </h2>
                <!-- Card Container: ปรับเป็น 2 คอลัมน์บนมือถือ และ w-full ใน Grid 2 คอลัมน์หลัก -->
                <div id="pump-status-card-container" class="flex flex-wrap gap-2 overflow-y-auto p-1 -m-1 flex-grow justify-start">
                    <!-- Cards will be injected by JavaScript -->
                </div>
            </div>
            
        </main>
    </div>

    <!-- Footer Section -->
    <footer class="mt-4 flex-shrink-0 text-center text-sm text-gray-400">
        <p>Dashboard Powered by Gemini and deployed on GitHub Pages.</p>
        <p class="mt-1 font-semibold text-gray-600">
            **สำคัญ:** หากข้อมูล Sheet 4 (ปริมาณน้ำฝน) ไม่แสดง โปรดตรวจสอบ GOOGLE_SHEET_URL_4 และ ชื่อคอลัมน์ใน USER_COLUMN_NAMES
        </p>
    </footer>

    <!-- Modal Structure for Pump Inspection Count -->
    <div id="inspection-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center transition-opacity duration-300">
        <!-- Modal Content -->
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4 transform transition-all sm:my-8 sm:align-middle">
            <div class="flex justify-between items-start mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="ClipboardList" class="w-6 h-6 mr-2 text-indigo-600"></i>
                    ข้อมูลการเข้าตรวจสถานี
                </h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-600 transition" onclick="closeInspectionModal()">
                    <i data-lucide="X" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600">
                    <span class="font-semibold text-gray-800">สถานี:</span> 
                    <span id="modal-station-name" class="text-indigo-700 font-bold"></span>
                </p>
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-500 mb-1">จำนวนครั้งที่เข้าตรวจ (สะสม)</p>
                    <p id="modal-inspection-count" class="text-4xl font-extrabold text-blue-600">
                        0
                    </p>
                    <p class="text-xs text-gray-500 mt-2">* ข้อมูลจากคอลัมน์ที่ท่านกำหนดใน USER_COLUMN_NAMES</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition" onclick="closeInspectionModal()">
                    ปิด
                </button>
            </div>
        </div>
    </div>
    <!-- End Modal Structure -->

</body>
</html>
