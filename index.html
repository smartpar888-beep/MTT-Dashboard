<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- D3.js CDN for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    
    <style>
        /* กำหนดฟอนต์ Inter สำหรับ Tailwind (แนะนำสำหรับ UI) */
        :root {
            font-family: 'Inter', sans-serif;
        }
        
        /* CSS เพื่อให้พอดีหน้าจอ 100% (Full Screen) และบังคับอัตราส่วน 16:9 สำหรับ Layout หลัก */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
            overflow: hidden; /* ซ่อน scrollbar หลักของ body */
        }
        
        /* Container หลักที่ใช้พื้นที่เต็มจอ */
        .full-screen-container {
            height: 100vh; 
            display: flex;
            flex-direction: column;
            padding: 1.5rem; 
        }

        /* -------------------------------------------------------- */
        /* Custom Grid: สำหรับ Desktop (สัดส่วนตามรูปภาพที่อัพโหลด) */
        /* -------------------------------------------------------- */
        .custom-dashboard-grid {
            /* 100% ความสูงของพื้นที่เนื้อหาหลัก */
            height: 100%; 
            display: grid;
            /* **[ปรับปรุง]** 2 แถว: 1.5fr (บน - 60%) / 1fr (ล่าง - 40%) */
            grid-template-rows: 1.5fr 1fr; 
            /* 12 คอลัมน์ (เพื่อกำหนดสัดส่วนความกว้าง) */
            grid-template-columns: repeat(12, 1fr); 
            gap: 1.5rem;
            /* ป้องกันการ Scroll ภายใน Grid */
            overflow: hidden; 
        }

        /* 1. Area 1 (Sheet 1) - Top Left */
        .area-1-orange {
            grid-column: span 8; /* 8/12 = 66.6% */
            grid-row: 1;
        }

        /* 2. Area 2 (Sheet 2) - Top Right */
        .area-2-yellow {
            grid-column: span 4; /* 4/12 = 33.3% */
            grid-row: 1;
        }

        /* 3. Area 3 (Sheet 4 - Graph) - Bottom Left (4/12) */
        .area-3-blue {
            grid-column: span 4; /* 4/12 = 33.3% */
            grid-row: 2;
        }
        
        /* 4. Area 4 (Sheet 3 - Cards) - Bottom Right (8/12) */
        .area-4-green {
            grid-column: span 8; /* 8/12 = 66.6% */
            grid-row: 2;
        }
        
        /* -------------------------------------------------------- */
        /* Custom Styles for Consistency and Extreme Fit to Frame */
        /* (Font sizes are consistent across Area 1 and Area 2) */
        /* -------------------------------------------------------- */
        
        /* *** Area 1 Styles (Standard Small Font, Standard Padding) *** */
        .table-td-area1 { 
            padding: 0.35rem 0.6rem; 
            font-size: 0.75rem; /* 12px (text-xs) - Base data font size */
        }
        .table-th-area1 { 
            padding: 0.35rem 0.6rem;
            font-size: 0.65rem; /* ~10.4px - Header text size */
            font-weight: 600;
            color: #6b7280; /* gray-500 */
            text-transform: uppercase;
        }
        .text-lg-area1 { /* สำหรับค่าระดับน้ำปัจจุบันใน Area 1 */
            font-size: 0.85rem; /* ~13.6px - Current level value */
        }

        /* *** Area 2 Styles (Same Font Size, Reduced Padding for Narrow Fit) *** */
        .table-td-area2 { 
            padding: 0.15rem 0.3rem; /* Padding Reduced Significantly for FIT */
            font-size: 0.75rem; /* 12px (text-xs) - Base data font size (CONSISTENT with Area 1) */
        }
        .table-th-area2 { 
            padding: 0.15rem 0.3rem; /* Padding Reduced Significantly for FIT */
            font-size: 0.65rem; /* ~10.4px - Header text size (CONSISTENT with Area 1) */
            font-weight: 600;
            color: #6b7280; /* gray-500 */
            text-transform: uppercase;
        }
        .text-base-area2 { /* สำหรับค่าระดับน้ำปัจจุบันใน Area 2 */
            font-size: 0.85rem; /* ~13.6px - Current level value (CONSISTENT with Area 1) */
        }
        
        /* ปรับขนาด Status Badge ให้เล็กลงมากเพื่อให้พอดีแถว */
        .status-badge {
            padding: 0.05rem 0.3rem; 
            font-size: 0.75rem; /* 12px (text-xs) - Base data font size (CONSISTENT with Area 1) */
            white-space: nowrap; 
        }
        .status-badge i { /* Icon inside status badge */
             width: 0.65rem; 
             height: 0.65rem;
             margin-right: 0.15rem;
        }
        
        /* ไอคอนในคอลัมน์ ส่วนต่าง */
        .icon-area1 {
            width: 0.875rem; /* 14px */
            height: 0.875rem;
        }
        .icon-area2 {
            width: 0.75rem; /* 12px */
            height: 0.75rem;
        }
        
        /* D3 Chart Text Styling */
        #rainfall-chart-container text {
            font-family: 'Inter', sans-serif;
            font-size: 9px; 
        }

        /* For mobile/small screen: Use 1 column layout */
        @media (max-width: 768px) {
            .custom-dashboard-grid {
                display: flex;
                flex-direction: column;
                height: auto; 
                overflow-y: auto;
            }
            .area-1-orange, .area-2-yellow, .area-3-blue, .area-4-green {
                /* Reset to full width on mobile */
                width: 100%;
                grid-column: span 12;
                grid-row: auto;
                min-height: 400px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 full-screen-container">
    
    <script>
        // =================================================================================================================================================
        // ส่วนที่ 1: การกำหนดค่าและ URL ของแหล่งข้อมูล (เหมือนเดิม)
        // =================================================================================================================================================
        
        // *************************************************************************************************************************************************
        // ** สำคัญ: กรุณาแทนที่ URL ตัวอย่างเหล่านี้ด้วย URL จริงของ Google Sheets ที่คุณเผยแพร่เป็น CSV **
        // *************************************************************************************************************************************************
        const GOOGLE_SHEET_URL_1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT452CdpcF_hoA-_x3a6Ji0YKeWTuSr_9CM0We83aAAPiBWMRoHrKEujaYtEzHMZYMLEL8wKa10NPYF/pub?gid=675852265&single=true&output=csv"; // ตรวจวัดระดับ
        const GOOGLE_SHEET_URL_2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5OYSm3Hn1V4kegJf9x3iK2OGvUIL7vbnWryNUsx15VCm4NdxoVoWZMx1vWTlKcZskeD-YYjhbKn2V/pub?gid=202563025&single=true&output=csv"; // ข้อมูลระดับน้ำเจ้าพระยา
        const GOOGLE_SHEET_URL_3 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyPcfGQReUPOHckF-6bA4UOucC8cbqRvHj-aTP7uWRkBjvQ4HrieGIhcet4OH9O0DjT_M2FM3QaaV9/pub?gid=273571070&single=true&output=csv"; // ข้อมูลการตรวจสอบการทำงานของเครื่องสูบน้ำ
        const GOOGLE_SHEET_URL_4 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5qwzKbaRjpA3iUXbyNMg9Y0tYdlVwykSAxz1V_CxMoT6PwnmMZjKvSNR2PpSWFjwbr9aG8uIU23tN/pub?gid=77454851&single=true&output=csv"; // ข้อมูลปริมาณน้ำฝน 
        
        // ระยะเวลาการอัปเดต: 1 ชั่วโมง = 3600000 มิลลิวินาที
        const UPDATE_INTERVAL_MS = 3600000;

        // ตรวจสอบว่า URL ยังเป็นค่า placeholder หรือไม่
        const PLACEHOLDER_URL_CHECK = 
            GOOGLE_SHEET_URL_1.includes('{SHEET_ID_1}') || 
            GOOGLE_SHEET_URL_2.includes('{SHEET_ID_2}') || 
            GOOGLE_SHEET_URL_3.includes('{SHEET_ID_3}') || 
            GOOGLE_SHEET_URL_4.includes('{SHEET_ID_4}');

        // =================================================================================================================================================
        // ส่วนที่ 2: การกำหนดค่าชื่อคอลัมน์ (USER CONFIGURATION) และ KEY MAP (เหมือนเดิม)
        // =================================================================================================================================================
        
        const USER_COLUMN_NAMES = {
            SHEET_1_2: {
                POINT: 'จุดวัด',                 
                LEVEL: 'ระดับน้ำปัจจุบัน',       
                DIFF: 'ส่วนต่างระดับน้ำ',         
                ALERT: 'ระดับการแจ้งเตือน',       
            },
            SHEET_3: {
                STATION: 'สถานีสูบน้ำ',           
                STATUS: 'สถานะปั๊ม',             
                UPDATE: 'เวลาล่าสุด',             
                INSPECTIONS: 'จำนวนครั้งการเข้าตรวจ', 
            },
             SHEET_4: {
                POINT: 'จุดวัดประมาณน้ำฝน',     
                AMOUNT: 'ปริมาณน้ำฝน',          
                DURATION: 'ระยะเวลาฝนตก',       
            }
        };

        function sanitizeText(text) {
            if (!text) return '';
            return text.trim().replace(/\s+/g, '').replace(/\uFEFF/g, '');
        }

        const KEY_MAP = {
            WATER_POINT: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.POINT), 
            CURRENT_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.LEVEL),
            DIFF_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.DIFF),
            ALERT_LEVEL: sanitizeText(USER_COLUMN_NAMES.SHEET_1_2.ALERT),

            PUMP_STATION: sanitizeText(USER_COLUMN_NAMES.SHEET_3.STATION),
            PUMP_STATUS: sanitizeText(USER_COLUMN_NAMES.SHEET_3.STATUS),
            LAST_UPDATE: sanitizeText(USER_COLUMN_NAMES.SHEET_3.UPDATE),
            INSPECTIONS: sanitizeText(USER_COLUMN_NAMES.SHEET_3.INSPECTIONS), 
            
            RAIN_POINT: sanitizeText(USER_COLUMN_NAMES.SHEET_4.POINT), 
            RAIN_AMOUNT: sanitizeText(USER_COLUMN_NAMES.SHEET_4.AMOUNT),
            RAIN_DURATION: sanitizeText(USER_COLUMN_NAMES.SHEET_4.DURATION),
        };

        function csvToArray(csvText) {
             const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const cleanHeaders = rawHeaders.map(h => sanitizeText(h)); 
            
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i];
                
                const values = currentLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                
                if (values.length === cleanHeaders.length) {
                    const obj = {};
                    let hasRequiredKey = false;
                    for (let j = 0; j < cleanHeaders.length; j++) {
                        obj[cleanHeaders[j]] = values[j]; 
                        if (cleanHeaders[j] === KEY_MAP.WATER_POINT || cleanHeaders[j] === KEY_MAP.PUMP_STATION || cleanHeaders[j] === KEY_MAP.RAIN_POINT) {
                             hasRequiredKey = true;
                        }
                    }
                    
                    if (hasRequiredKey) {
                         result.push(obj);
                    }
                } else {
                    // console.warn(`[Parsing Error] Skipping data line ${i+1}: Column count mismatch (${values.length} found, ${cleanHeaders.length} expected).`);
                }
            }
            return result;
        }

        async function fetchDataFromSheet(url) {
            console.log(`[INFO] Attempting to fetch data from URL: ${url}`);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${url}`);
                }
                const csvText = await response.text();
                return csvToArray(csvText);
            } catch (error) {
                console.error("Error fetching or parsing sheet data:", error);
                return [
                    { 'ERROR_KEY': 'N/A (Error)', [KEY_MAP.ALERT_LEVEL]: 'ไม่ได้เชื่อมต่อ' },
                ];
            }
        }

        async function fetchWaterLevelData() { return fetchDataFromSheet(GOOGLE_SHEET_URL_1); }
        async function fetchChaoPhrayaData() { return fetchDataFromSheet(GOOGLE_SHEET_URL_2); }
        async function fetchPumpStatusData() { return fetchDataFromSheet(GOOGLE_SHEET_URL_3); }
        async function fetchRainfallData() { return fetchDataFromSheet(GOOGLE_SHEET_URL_4); }
        
        // =================================================================================================================================================
        // ส่วนที่ 3: ฟังก์ชันการแสดงผล (Rendering)
        // =================================================================================================================================================
        
        function getAlertStyles(alertLevel) {
            const sanitizedLevel = sanitizeText(alertLevel);
            
            if (sanitizedLevel.includes('วิกฤติ') || sanitizedLevel.includes('ผิดปกติ') || sanitizedLevel.includes('อันตราย') || sanitizedLevel.includes('แจ้งเตือน')) {
                return { color: 'bg-red-100 text-red-800 ring-red-300', icon: 'AlertTriangle', iconColor: 'text-red-500' };
            }
            
            if (sanitizedLevel.includes('เฝ้าระวัง') || sanitizedLevel.includes('สูง')) {
                return { color: 'bg-amber-100 text-amber-800 ring-amber-300', icon: 'Eye', iconColor: 'text-amber-500' };
            }
            
            if (sanitizedLevel.includes('ปกติ') || sanitizedLevel.includes('ทำงาน')) {
                return { color: 'bg-green-100 text-green-800 ring-green-300', icon: 'CheckCircle', iconColor: 'text-green-500' };
            }
            
            if (sanitizedLevel.includes('ไม่ทำงาน')) {
                return { color: 'bg-indigo-100 text-indigo-800 ring-indigo-300', icon: 'PauseCircle', iconColor: 'text-indigo-500' };
            }

            return { color: 'bg-gray-100 text-gray-800 ring-gray-300', icon: 'Info', iconColor: 'text-gray-500' };
        }

        function getDiffIcon(diff) {
            const numDiff = parseFloat(diff);
            if (isNaN(numDiff)) return { icon: 'Minus', iconColor: 'text-gray-500' };

            if (numDiff > 0.001) {
                return { icon: 'ArrowUp', iconColor: 'text-red-500' }; 
            } else if (numDiff < -0.001) {
                return { icon: 'ArrowDown', iconColor: 'text-green-500' }; 
            } else {
                return { icon: 'Minus', iconColor: 'text-gray-500' };
            }
        }

        /**
         * สร้างแถวตารางสำหรับข้อมูลระดับน้ำ (Sheet 1 & 2)
         */
        function createWaterTableRow(data, isSheet1) {
            const alertLevel = data[KEY_MAP.ALERT_LEVEL] || 'N/A';
            const alertStyles = getAlertStyles(alertLevel);
            const diffValue = data[KEY_MAP.DIFF_LEVEL] || '0.00';
            const diffIcon = getDiffIcon(diffValue);

            const displayLevel = data[KEY_MAP.CURRENT_LEVEL] || 'N/A';
            const pointName = data[KEY_MAP.WATER_POINT] || '';
            let unit = 'รทก./MSL.'; 

            if (pointName.includes('เขื่อนเจ้าพระยา')) { unit = 'ลบ.ม./วินาที'; } 
            if (displayLevel === 'N/A') { unit = ''; }

            // กำหนด CSS Class ใหม่ที่ถูกปรับให้ FIT และ CONSISTENT กับกรอบ
            const tdClass = isSheet1 ? 'table-td-area1' : 'table-td-area2';
            const levelTextClass = isSheet1 ? 'text-lg-area1 font-bold' : 'text-base-area2 font-semibold';
            const iconSize = isSheet1 ? 'icon-area1' : 'icon-area2'; 

            return `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="${tdClass} whitespace-nowrap font-medium text-gray-900">
                        ${data[KEY_MAP.WATER_POINT] || 'N/A'} 
                    </td>
                    <td class="${tdClass} whitespace-nowrap ${levelTextClass} text-gray-900">
                        ${displayLevel} ${unit}
                    </td>
                    <td class="${tdClass} whitespace-nowrap text-xs text-gray-600">
                        <div class="flex items-center space-x-1">
                            <span class="font-semibold ${diffIcon.iconColor}">
                                ${diffValue}
                            </span>
                            <i data-lucide="${diffIcon.icon}" class="${iconSize} ${diffIcon.iconColor}"></i>
                        </div>
                    </td>
                    <td class="${tdClass} whitespace-nowrap">
                        <span class="status-badge ${alertStyles.color} ring-1 ring-inset">
                             <i data-lucide="${alertStyles.icon}" class="status-badge i"></i>
                            ${alertLevel}
                        </span>
                    </td>
                </tr>
            `;
        }
        
        /**
         * สร้าง Card สำหรับข้อมูลสถานะปั๊ม (Sheet 3)
         */
        function createPumpStatusCard(data) {
            const pumpStation = data[KEY_MAP.PUMP_STATION] || 'N/A';
            const pumpStatus = data[KEY_MAP.PUMP_STATUS] || 'ไม่พบสถานะ';
            const inspectionCount = data[KEY_MAP.INSPECTIONS] || '0'; 
            const sanitizedStatus = sanitizeText(pumpStatus);

            let bgColor = 'bg-gray-100';
            let textColor = 'text-gray-800';
            let icon = 'Info';

            if (sanitizedStatus.includes('ปกติ') || sanitizedStatus.includes('ทำงาน')) {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                icon = 'CheckCircle';
            } else if (sanitizedStatus.includes('ผิดปกติ') || sanitizedStatus.includes('วิกฤติ') || sanitizedStatus.includes('ไม่ทำงาน') || sanitizedStatus.includes('แจ้งเตือน')) {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                icon = 'AlertTriangle';
            } else {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
                icon = 'Eye';
            }

            const safeStationName = pumpStation.replace(/'/g, "\\'");
            const safeInspectionCount = inspectionCount.replace(/'/g, "\\'");
            
            // ปรับขนาดการ์ดและตัวอักษรให้เล็กลง เพื่ออัด Card ให้เต็มพื้นที่ Green Area (8/12 Width)
            return `
                <div 
                    class="p-2.5 ${bgColor} rounded-lg shadow-sm ring-1 ring-inset ring-opacity-50 flex items-start space-x-1 transition duration-200 hover:ring-2 hover:ring-offset-2 hover:ring-opacity-100 cursor-pointer w-full"
                    onclick="showInspectionModal('${safeStationName}', '${safeInspectionCount}')"
                >
                    <i data-lucide="${icon}" class="w-4 h-4 mt-0.5 ${textColor} flex-shrink-0"></i> 
                    <div class="flex flex-col min-w-0"> 
                        <span class="text-sm font-semibold ${textColor} truncate">
                            ${pumpStation}
                        </span>
                        <span class="text-[11px] ${textColor} opacity-85 mt-[-2px] truncate">
                            ${pumpStatus}
                        </span>
                    </div>
                </div>
            `;
        }

        function showInspectionModal(stationName, inspectionCount) {
            const modal = document.getElementById('inspection-modal');
            const stationNameElement = document.getElementById('modal-station-name');
            const inspectionCountElement = document.getElementById('modal-inspection-count');

            if (modal && stationNameElement && inspectionCountElement) {
                stationNameElement.textContent = stationName;
                inspectionCountElement.textContent = inspectionCount; 
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeInspectionModal() {
            const modal = document.getElementById('inspection-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        function displaySheet4Error(containerId, data) {
            const container = document.querySelector(containerId);
            const isUrlPlaceholder = GOOGLE_SHEET_URL_4.includes('{SHEET_ID_4}');
            
            let message = '';
            let title = '';

            if (isUrlPlaceholder) {
                 title = "❗ ไม่ได้ระบุ URL ของ Sheet 4";
                 message = "กรุณาแทนที่ GOOGLE_SHEET_URL_4 ด้วย Link CSV ที่เผยแพร่แล้วของท่าน";
            } else if (data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'))) {
                 title = "❌ ไม่สามารถโหลดข้อมูล Sheet 4 ได้";
                 message = "ตรวจสอบ URL/การเผยแพร่ และชื่อคอลัมน์หลัก";
            } else {
                 title = "⚠️ ข้อมูลไม่พร้อมใช้งานสำหรับกราฟ";
                 message = "ไม่พบค่า 'ปริมาณน้ำฝน' ที่เป็นตัวเลข หรือ 'จุดวัด' ที่ถูกต้อง";
            }
            
            container.innerHTML = `
                <div class="p-4 text-center bg-red-50/50 rounded-lg border border-red-300 h-full flex flex-col items-center justify-center">
                    <h3 class="text-xl font-bold text-red-800 mb-1">${title}</h3>
                    <p class="text-red-700 text-sm">${message}</p>
                </div>
            `;
        }
        
        /**
         * วาดกราฟแท่งปริมาณน้ำฝนโดยใช้ D3.js (Sheet 4) 
         */
        function drawRainfallBarChart(data) {
            const containerId = '#rainfall-chart-container';
            const container = document.querySelector(containerId);
            
            // ล้าง SVG เก่า
            d3.select(containerId).select("svg").remove();

            const isUrlPlaceholder = GOOGLE_SHEET_URL_4.includes('{SHEET_ID_4}');
            const isFetchError = data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'));

            if (isUrlPlaceholder || isFetchError) {
                displaySheet4Error(containerId, data);
                return;
            }

            const chartData = data
                .map(d => ({
                    point: d[KEY_MAP.RAIN_POINT] || 'N/A',
                    amount: parseFloat(d[KEY_MAP.RAIN_AMOUNT])
                }))
                .filter(d => !isNaN(d.amount) && d.point !== 'N/A' && d.amount >= 0);

            if (chartData.length === 0) {
                 displaySheet4Error(containerId, data);
                 return;
            }
            
            // กำหนดขนาดและขอบเขต
            const margin = { top: 20, right: 10, bottom: 60, left: 40 }; 
            
            // ใช้ขนาดของ Container ปัจจุบัน
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight; 
            
            const width = Math.max(containerWidth - margin.left - margin.right, 200);
            const height = Math.max(containerHeight - margin.top - margin.bottom, 200); 

            // สร้าง SVG Element
            const svg = d3.select(containerId)
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
                
            // กำหนด Scale
            const x = d3.scaleBand()
                .domain(chartData.map(d => d.point))
                .range([0, width])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.amount) * 1.1]) 
                .range([height, 0]);

            // วาด Axis
            // X-Axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)") 
                .style("text-anchor", "end")
                .style("font-size", "9px"); 

            // Y-Axis
            svg.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .style("font-size", "9px"); 

            // Y-Axis Label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 2)
                .attr("x", 0 - (height / 2))
                .attr("dy", "0.8em")
                .style("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#4b5563")
                .text("ปริมาณน้ำฝน (มม.)"); 

            // วาด Bar
            svg.selectAll(".bar")
                .data(chartData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.point))
                .attr("y", height) 
                .attr("width", x.bandwidth())
                .attr("height", 0) 
                .attr("fill", "#2563eb") // Blue-600
                .attr("rx", 3) 
                .transition() 
                .duration(800)
                .delay((d, i) => i * 100)
                .attr("y", d => y(d.amount))
                .attr("height", d => height - y(d.amount));
                
            // เพิ่ม Text Label บน Bar
            svg.selectAll(".label")
                .data(chartData)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => x(d.point) + x.bandwidth() / 2)
                .attr("y", d => y(d.amount))
                .attr("dy", "-0.3em") 
                .attr("text-anchor", "middle")
                .style("font-size", "9px")
                .style("font-weight", "bold")
                .style("fill", "#1e293b") 
                .text(d => d.amount.toFixed(2));
                
            function handleResize() {
                // Redraw chart completely on resize
                if (container.clientWidth > 0 && container.clientHeight > 0) {
                    drawRainfallBarChart(data);
                }
            }
            window.removeEventListener('resize', handleResize);
            window.addEventListener('resize', handleResize);
        }

        /**
         * อัปเดตส่วนแสดงผลระดับน้ำและเครื่องสูบน้ำ
         */
        function updateTable(elementId, data) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.innerHTML = ''; 
            
            const isSheet1 = elementId === 'water-level-table-body';
            const isPumpCardContainer = elementId === 'pump-status-card-container';
            
            const checkKey = isPumpCardContainer ? KEY_MAP.PUMP_STATION : KEY_MAP.WATER_POINT;
            
            const isError = data.length === 0 || (data.length > 0 && (data[0]?.['ERROR_KEY'] || '').includes('Error'));
            const colSpan = 4; // สำหรับตาราง

            if (isError) {
                const errorMessage = 'ไม่สามารถดึงข้อมูลได้ (ตรวจสอบ URL/การเผยแพร่ และชื่อคอลัมน์)';
                
                if (!isPumpCardContainer) { 
                    container.innerHTML = `
                        <tr>
                            <td colspan="${colSpan}" class="p-8 text-center text-red-500 bg-red-50/50">
                                <i data-lucide="CloudOff" class="w-6 h-6 mx-auto mb-2"></i>
                                ${errorMessage}
                            </td>
                        </tr>
                    `;
                } else {
                    // ปรับขนาด Error Card ให้เล็กลงเพื่อให้พอดีพื้นที่ Green Area
                    container.innerHTML = `
                        <div class="col-span-full w-full p-4 text-center text-red-500 bg-red-50/50 rounded-lg">
                            <i data-lucide="CloudOff" class="w-6 h-6 mx-auto mb-2"></i>
                            ${errorMessage}
                        </div>
                    `;
                }
            } else {
                // Render data
                if (isPumpCardContainer) {
                    // For Sheet 3 Cards
                    data.forEach(item => {
                        container.innerHTML += createPumpStatusCard(item);
                    });
                } else {
                    // For Sheet 1 & 2 Tables
                    data.forEach(item => {
                        container.innerHTML += createWaterTableRow(item, isSheet1); 
                    });
                }
            }

            lucide.createIcons();
        }

        /**
         * ฟังก์ชันตรวจสอบและแจ้งเตือนเมื่อ URL ยังเป็นค่าเริ่มต้น (เหมือนเดิม)
         */
        function checkPlaceholderUrls() {
            const errorElement = document.getElementById('url-placeholder-error');
            if (PLACEHOLDER_URL_CHECK) {
                errorElement.innerHTML = `
                    <div class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-red-800 font-medium">
                        ⚠️ ข้อผิดพลาด: URL ยังเป็นค่าเริ่มต้น!
                        <span class="block mt-1 font-normal text-sm">กรุณาแทนที่ GOOGLE_SHEET_URL_1 ถึง 4 ในโค้ด JS ด้วยลิงก์ CSV ที่เผยแพร่แล้วของท่าน</span>
                    </div>
                `;
                const lastUpdateTimeElement = document.getElementById('last-update-time');
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = 'หยุดการอัปเดต (ข้อผิดพลาด URL)';
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                    lastUpdateTimeElement.classList.add('text-red-500');
                }
                return true;
            } else {
                errorElement.innerHTML = '';
                return false;
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 4: ฟังก์ชันหลักในการอัปเดต Dashboard (เหมือนเดิม)
        // =================================================================================================================================================

        let isUpdating = false;

        async function updateDashboard() {
            if (isUpdating || checkPlaceholderUrls()) {
                return;
            }
            isUpdating = true;
            
            const lastUpdateTimeElement = document.getElementById('last-update-time');
            if (lastUpdateTimeElement) {
                lastUpdateTimeElement.textContent = 'กำลังอัปเดตข้อมูล...';
                lastUpdateTimeElement.classList.add('animate-pulse');
                lastUpdateTimeElement.classList.remove('text-red-500'); 
            }

            try {
                const [
                    waterLevelData, 
                    chaoPhrayaData, 
                    pumpStatusData,
                    rainfallData
                ] = await Promise.all([
                    fetchWaterLevelData(),
                    fetchChaoPhrayaData(),
                    fetchPumpStatusData(),
                    fetchRainfallData() 
                ]);

                // 1. Sheet 1
                updateTable('water-level-table-body', waterLevelData); 
                // 2. Sheet 2
                updateTable('chaophraya-table-body', chaoPhrayaData); 
                // 3. Sheet 3 Cards
                updateTable('pump-status-card-container', pumpStatusData); 
                // 4. Sheet 4 Graph
                drawRainfallBarChart(rainfallData);
                
                // อัปเดตเวลาล่าสุด
                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = `อัปเดตล่าสุด: ${timeString}`;
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                }

            } catch (error) {
                console.error("Critical error during dashboard update:", error);
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = 'ไม่สามารถอัปเดตได้ (โปรดตรวจสอบ Console)';
                    lastUpdateTimeElement.classList.remove('animate-pulse');
                    lastUpdateTimeElement.classList.add('text-red-500');
                }
            } finally {
                isUpdating = false;
            }
        }

        // =================================================================================================================================================
        // ส่วนที่ 5: การเริ่มต้น (Initialization)
        // =================================================================================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkPlaceholderUrls();
            
            if (!PLACEHOLDER_URL_CHECK) {
                updateDashboard();
                setInterval(updateDashboard, UPDATE_INTERVAL_MS);
            }
            
            document.getElementById('refresh-button').addEventListener('click', updateDashboard);
            
            document.getElementById('inspection-modal').addEventListener('click', (event) => {
                if (event.target.id === 'inspection-modal' || event.target.closest('#modal-close-button')) {
                    closeInspectionModal();
                }
            });
        });

    </script>
    
    <!-- Header Section -->
    <!-- flex-shrink-0 เพื่อป้องกัน Header ถูกบีบอัดเมื่อหน้าจอเล็ก -->
    <header class="mb-6 flex-shrink-0"> 
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">
                    Dashboard การบริหารจัดการน้ำและสิ่งแวดล้อม
                </h1>
                <p class="text-gray-500 mt-1">
                    ภาพรวมสถานการณ์ระดับน้ำ และเครื่องสูบน้ำแบบเรียลไทม์
                </p>
                <!-- Area for URL Placeholder Error Message -->
                <div id="url-placeholder-error"></div>
            </div>
            <div class="flex items-center space-x-3">
                <span id="last-update-time" class="text-sm font-medium text-gray-600 transition-all duration-500">
                    กำลังโหลด...
                </span>
                <button id="refresh-button" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    <i data-lucide="RefreshCw" class="w-4 h-4 mr-2"></i>
                    อัปเดตทันที
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content Container: ใช้พื้นที่ความสูงที่เหลือทั้งหมด -->
    <!-- h-[calc(100vh-100px)] คำนวณความสูงที่เหลือจากการหัก Header/Footer ออก -->
    <main class="custom-dashboard-grid md:h-[calc(100vh-100px)]"> 
            
        <!-- 1. Area 1 (Sheet URL 1: สถานะการตรวจวัดระดับ) - Orange Area (8/12 width, ~60% height) -->
        <div class="area-1-orange bg-white p-6 rounded-xl shadow-lg flex flex-col overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                <i data-lucide="Gauge" class="w-5 h-5 mr-2 text-orange-600"></i>
                สถานะการตรวจวัดระดับน้ำ (4 จุด - 4 รอบ/วัน)
            </h2>
            <!-- ลบ overflow-y-auto เพื่อบังคับให้ Fit -->
            <div class="flex-grow -mx-6 px-6 overflow-hidden"> 
                <table class="table-auto divide-y divide-gray-200 w-full"> 
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="table-th-area1 text-left uppercase tracking-wider whitespace-nowrap">
                                จุดวัด
                            </th>
                            <th class="table-th-area1 text-left uppercase tracking-wider whitespace-nowrap">
                                ระดับน้ำปัจจุบัน
                            </th>
                            <th class="table-th-area1 text-left uppercase tracking-wider whitespace-nowrap">
                                ส่วนต่าง (เทียบครั้งก่อน)
                            </th>
                            <th class="table-th-area1 text-left uppercase tracking-wider whitespace-nowrap">
                                ระดับการแจ้งเตือน
                            </th>
                        </tr>
                    </thead>
                    <tbody id="water-level-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. Area 2 (Sheet URL 2: ระดับน้ำเจ้าพระยา) - Yellow Area (4/12 width, ~60% height) -->
        <div class="area-2-yellow bg-white p-4 rounded-xl shadow-lg flex flex-col overflow-hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center flex-shrink-0">
                <i data-lucide="Waves" class="w-4 h-4 mr-1 text-yellow-600"></i>
                ข้อมูลระดับน้ำเจ้าพระยา (4 จุด - 3 รอบ/วัน)
            </h2>
            <!-- ลบ overflow-y-auto เพื่อบังคับให้ Fit -->
            <div class="flex-grow -mx-4 px-4 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="table-th-area2 text-left uppercase tracking-wider whitespace-nowrap">
                                จุดวัด
                            </th>
                            <th class="table-th-area2 text-left uppercase tracking-wider whitespace-nowrap">
                                ระดับน้ำ
                            </th>
                            <th class="table-th-area2 text-left uppercase tracking-wider whitespace-nowrap">
                                ส่วนต่าง
                            </th>
                            <th class="table-th-area2 text-left uppercase tracking-wider whitespace-nowrap">
                                แจ้งเตือน
                            </th>
                        </tr>
                    </thead>
                    <tbody id="chaophraya-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 3. Area 3 (Sheet URL 4: ปริมาณและระยะเวลาฝนตก - GRAPH ONLY) - Blue Area (4/12 width, ~40% height) -->
        <div class="area-3-blue bg-white p-6 rounded-xl shadow-lg flex flex-col overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                <i data-lucide="CloudRain" class="w-5 h-5 mr-2 text-blue-600"></i>
                ปริมาณน้ำฝน (มม.) และระยะเวลา
            </h2>
            <!-- Chart Container: flex-grow เพื่อยึดพื้นที่ที่เหลือทั้งหมด -->
            <div id="rainfall-chart-container" class="w-full flex-grow min-h-[150px]"> 
                <!-- Chart will be drawn here, or error message will be displayed -->
            </div>
        </div>


        <!-- 4. Area 4 (Sheet URL 3: สถานะเครื่องสูบน้ำ - CARDS) - Green Area (8/12 width, ~40% height) -->
        <div class="area-4-green bg-white p-6 rounded-xl shadow-lg flex flex-col overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
                <i data-lucide="Box" class="w-5 h-5 mr-2 text-green-600"></i>
                สถานะเครื่องสูบน้ำ (14 สถานี)
            </h2>
            <!-- Card Container: ใช้ Grid ภายใน เพื่ออัด Card ให้เต็มพื้นที่ -->
            <div id="pump-status-card-container" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 overflow-y-auto flex-grow">
                <!-- Cards will be injected by JavaScript -->
            </div>
        </div>
        
    </main>

    <!-- Footer Section -->
    <footer class="mt-4 flex-shrink-0 text-center text-sm text-gray-400">
        <p>Dashboard Powered by Gemini and deployed on GitHub Pages.</p>
        <p class="mt-1 font-semibold text-gray-600">
            **สำคัญ:** หากข้อมูลไม่โหลด หรือขึ้นว่า "หยุดการอัปเดต" โปรดตรวจสอบ GOOGLE_SHEET_URL ทั้ง 4 ลิงก์ว่าถูกแทนที่ด้วยลิงก์ CSV ที่เผยแพร่แล้วหรือไม่
        </p>
    </footer>

    <!-- Modal Structure for Pump Inspection Count -->
    <div id="inspection-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center transition-opacity duration-300">
        <!-- Modal Content (No change) -->
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4 transform transition-all sm:my-8 sm:align-middle">
            <div class="flex justify-between items-start mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="ClipboardList" class="w-6 h-6 mr-2 text-indigo-600"></i>
                    ข้อมูลการเข้าตรวจสถานี
                </h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-600 transition" onclick="closeInspectionModal()">
                    <i data-lucide="X" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600">
                    <span class="font-semibold text-gray-800">สถานี:</span> 
                    <span id="modal-station-name" class="text-indigo-700 font-bold"></span>
                </p>
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-500 mb-1">จำนวนครั้งที่เข้าตรวจ (สะสม)</p>
                    <p id="modal-inspection-count" class="text-4xl font-extrabold text-blue-600">
                        0
                    </p>
                    <p class="text-xs text-gray-500 mt-2">* ข้อมูลจากคอลัมน์ที่ท่านกำหนดใน USER_COLUMN_NAMES</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition" onclick="closeInspectionModal()">
                    ปิด
                </button>
            </div>
        </div>
    </div>
    <!-- End Modal Structure -->

</body>
</html>
